name: Setup build
description: >
  Common repository and build tool setup

inputs:
  do-checkout:
    description: 'Flag to skip cloning the repository'
    default: 'true'
    required: false
  install-finch:
    description: 'Flag to install finch OCI tooling on mac hosts'
    default: 'true'
    required: false

runs:
  using: composite

  steps:
    - uses: actions/checkout@v4
      if: ${{ inputs.do-checkout == 'true' }}
      with:
        submodules: true
    - name: Configure JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'corretto'
        java-version: 17
        cache: 'gradle'
    # Cache the Kotlin/Native toolchain based on the input Kotlin version from version catalog
    # see https://kotlinlang.org/docs/native-improving-compilation-time.html
    - name: Cache Kotlin Native toolchain
      uses: actions/cache@v4
      with:
        path: |
          ~/.konan
        key: ${{ runner.os }}-konan-${{ hashFiles('gradle/libs.versions.toml') }}
        restore-keys: |
          ${{ runner.os }}-konan-
    - name: Install finch OCI client
      if:  ${{ runner.os == 'macOS' && inputs.install-finch == 'true' }}
      shell: bash
      run: |
        brew install --cask finch
        finch vm init
